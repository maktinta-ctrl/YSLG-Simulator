<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Source LG - Standalone Simulator</title>
    <!-- Tailwind CSS 3.4 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #151619; color: white; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        input[type="range"] { accent-color: #ea580c; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS & TYPES ---
        const DAYS = ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"];
        const FAN_TIMER_SEC = 900;
        const FA_TIMER_SEC = 900;
        const HEAT_ADJUST_DEG = 10;

        const COLOR_MAP = {
            '.': 'bg-zinc-800',
            'H': 'bg-orange-600',
            'C': 'bg-blue-400',
            'P': 'bg-emerald-500',
            'V': 'bg-blue-500',
            'T': 'bg-orange-700',
            'W': 'bg-orange-500',
            'M': 'bg-orange-800',
            'S': 'bg-red-600',
        };

        const TEMP_LABELS = {
            'H': '90°', 'C': '73°', 'P': 'PRG', 'V': '73°*', 'T': '90°*', 'W': '80°', 'M': '95°', 'S': '115°',
        };

        const BIG_SCHED = [
            ".....................HHHHHHHHHHHHHHHVCCCCHHHHHHVCCCCC...P....HHHHHHHHHHHHHHHHH..P...................", 
            ".................HHHHHH....HHHHHHHHHHHHHHHHHHHHVCCCCC...P...HHHHHHHHHHHHHVCCCC..P...................",   
            ".....................HHHHHH......HHHHHHHHHHHHHHVCCCCC...P....HHHHHHVCCCCHHHHH...P...................",  
            ".................HHHHHH....HHHHHHHHHHHHHHHHHHHHVCCCCC...P.....HHHHHPHHHHHHHHH...P...................",  
            ".....................HHHHHHHHHHH..HHHHHVCCCCHHHHVCCCC...P....HHHHHHHVCCCC.......P...................",  
            "..........................HHHHHHHHHHHHHHHHHHHHHHHH......P...........................................",   
            ".........................HHHHHH.VCCCCCCCHHHHHHHHHH......P........HHHHHHHHH......P...................",  
        ];

        const SMALL_SCHED = [
            "....................WWWWWWW.....WWWWWWWWVCCCCCC.MMMM....P...SSSSSSSSWWWWVCCCCC..P..................", 
            "....................WWWWWWW.....SSSSSSSSVCCCCCC.MMMM....P...WWWWWWWWSSSSSWWWW...P..................",   
            "................WWWWWWWWWWWWWWWW.WWWWWWWVCCCCCCC........P...SSSSSSSSTWWWSSSSSS..P..................",  
            ".....................WWWWWW.....SSSSSSSSP...............P...SSSSSSSS....VCCCCC..P..................",  
            ".................WWWWWW..........MMMMMMMVCCCCCC.WWWW....P...SSSSSSSSVCCCCC......P..................",  
            "........................WWWWWWWSSSSSWWWWVCCCCCCVCCCC....P.......................P...................",   
            "............................WWWWWWWSSSSSTWWWW...........P.........SSSSSSSS......P...................",  
        ];

        const REF_SCHED = [
            ".............................WWWW....WWWW....WWWW...............WWWWW...............................", 
            "...................WWWWWW....WWWW....WWWW....WWWW...............WWWWW...............................",  
            ".........................WWWW....WWWWWWWW....WWWW...............WWWWW...............................",  
            ".........................WWWW....WWWWWWWWWWWW...................WWWWWWWWWWWWW.......................", 
            "...................WWWWWW....WWWW....WWWW....WWWW...............WWWWWWWWW...........................", 
            "............................WWWWW....WWWW....WWWW...................................................",  
            "............................WWWWW....WWWW...........................................................",  
        ];

        // --- LOGIC FUNCTIONS ---
        function getScheduleChar(room, day, timeInSeconds) {
            const slotIndex = Math.floor(timeInSeconds / 900);
            const sched = room === 'big' ? BIG_SCHED : room === 'small' ? SMALL_SCHED : REF_SCHED;
            return sched[day][slotIndex] || '.';
        }

        function simulateStep(state) {
            const nextState = JSON.parse(JSON.stringify(state));
            const { currentTime, currentDay, ambientTemp } = nextState;
            const second = currentTime % 60;
            const minute = Math.floor((currentTime % 3600) / 60);
            const slotIndex = Math.floor(currentTime / 900);
            const heatAdj = ambientTemp > 95 ? HEAT_ADJUST_DEG : 0;

            processRoomLogic(nextState.bigRoom, BIG_SCHED[currentDay][slotIndex] || '.', second, minute, heatAdj, nextState.bigPurgeReq, 'big');
            processRoomLogic(nextState.smallRoom, SMALL_SCHED[currentDay][slotIndex] || '.', second, minute, heatAdj, nextState.smallPurgeReq, 'small');
            processRoomLogic(nextState.reformerRoom, REF_SCHED[currentDay][slotIndex] || '.', second, minute, heatAdj, false, 'ref');

            return nextState;
        }

        function processRoomLogic(room, char, second, minute, heatAdj, purgeReq, roomType) {
            if (char === '.') { room.mode = 'Off'; room.setpoint = 60; }
            else if (['H','W','M','S','T'].includes(char)) {
                room.mode = 'Heat';
                let base = 90;
                if (roomType === 'small') {
                    if (char === 'W') base = 90;
                    else if (char === 'M') base = 95;
                    else if (char === 'H' || char === 'S') base = 115;
                    else if (char === 'T') base = 90;
                } else if (roomType === 'big') {
                    base = 90;
                } else if (roomType === 'ref') {
                    base = 80;
                }
                room.setpoint = base - heatAdj;
            } else if (['C','V'].includes(char)) {
                room.mode = 'Cool';
                room.setpoint = 73;
            } else if (char === 'P') {
                room.mode = 'Off';
            }

            if (second === 0 && (minute % 15) === 0) {
                if (['P','V','T'].includes(char)) {
                    room.fanTimer = FAN_TIMER_SEC;
                    room.faTimer = FA_TIMER_SEC;
                }
            }

            if (room.fanTimer > 0) room.fanTimer--;
            if (room.faTimer > 0) room.faTimer--;
            room.purgeActive = purgeReq;

            if (room.tempOverride !== undefined) { room.temp = room.tempOverride; }

            const diff = room.setpoint - room.temp;
            if (room.mode === 'Heat') {
                if (diff > 1.0) room.runState = 1; 
                else if (diff < 0.2) room.runState = 0;
                if (room.tempOverride === undefined && !room.tempLocked) room.temp += room.runState === 1 ? 0.02 : -0.005;
            } else if (room.mode === 'Cool') {
                if (diff < -1.0) room.runState = 2;
                else if (diff > -0.2) room.runState = 0;
                if (room.tempOverride === undefined && !room.tempLocked) room.temp += room.runState === 2 ? -0.02 : 0.005;
            } else {
                room.runState = 0;
                if (room.tempOverride === undefined && !room.tempLocked) room.temp += (70 - room.temp) * 0.001;
            }

            if (roomType === 'ref') {
                room.fan = false; room.hum = false; room.fa = false;
                room.fanTimer = 0; room.faTimer = 0;
            } else {
                room.fan = room.fanTimer > 0 || room.purgeActive;
                room.hum = room.runState === 1;
                room.fa = room.faTimer > 0 || room.purgeActive || room.runState === 2;
            }
        }

        // --- COMPONENTS ---
        function Icon({ name, className }) {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        }

        function LegendItem({ color, label }) {
            return (
                <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-sm ${color}`} />
                    <span className="text-[10px] font-bold text-zinc-400">{label}</span>
                </div>
            );
        }

        function StatusIndicator({ iconName, label, active, timer }) {
            return (
                <div className={`p-4 flex flex-col items-center justify-center gap-2 border-r border-white/5 last:border-0 transition-colors ${active ? 'bg-orange-600/5' : ''}`}>
                    <Icon name={iconName} className={`w-4 h-4 transition-all duration-500 ${active ? 'text-orange-500 scale-110' : 'text-zinc-700'}`} />
                    <div className="flex flex-col items-center">
                        <span className={`text-[9px] font-bold uppercase tracking-tighter ${active ? 'text-zinc-300' : 'text-zinc-600'}`}>{label}</span>
                        {timer !== undefined && timer > 0 && (
                            <span className="text-[8px] font-mono text-orange-500 font-bold">
                                {Math.floor(timer / 60)}:{(timer % 60).toString().padStart(2, '0')}
                            </span>
                        )}
                    </div>
                </div>
            );
        }

        function RoomCard({ title, state, isReformer, onTempChange, onResetTemp, onToggleLock }) {
            const isHeating = state.runState === 1;
            const isCooling = state.runState === 2;

            return (
                <div className="bg-[#1a1b1e] rounded-2xl border border-white/5 overflow-hidden shadow-xl flex flex-col">
                    <div className="p-6 border-b border-white/5 flex items-center justify-between">
                        <h3 className="font-bold text-zinc-400 uppercase tracking-widest text-xs">{title}</h3>
                        <div className="flex gap-2">
                            <button onClick={onToggleLock} className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-tighter flex items-center gap-1 transition-colors ${state.tempLocked ? 'bg-orange-600 text-white' : 'bg-zinc-800 text-zinc-500 hover:text-zinc-400'}`}>
                                <Icon name={state.tempLocked ? "zap" : "activity"} className="w-3 h-3" />
                                {state.tempLocked ? 'Locked' : 'Live'}
                            </button>
                            <div className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-tighter ${state.mode === 'Off' ? 'bg-zinc-800 text-zinc-500' : state.mode === 'Heat' ? 'bg-orange-600/20 text-orange-500' : 'bg-blue-600/20 text-blue-500'}`}>
                                {state.mode}
                            </div>
                        </div>
                    </div>

                    <div className="p-8 flex flex-col items-center justify-center relative min-h-[160px]">
                        <div className="relative z-10 text-center">
                            <div className="text-5xl font-bold tracking-tighter mb-1 flex items-baseline justify-center">
                                {state.temp.toFixed(1)}<span className="text-xl text-zinc-500 ml-1">°F</span>
                            </div>
                            <div className="text-xs font-mono text-zinc-500 uppercase tracking-widest flex items-center justify-center gap-2">
                                <Icon name="zap" className={`w-3 h-3 ${state.runState !== 0 ? 'text-orange-500 animate-pulse' : ''}`} />
                                Setpoint: {state.setpoint}°F
                            </div>
                        </div>
                    </div>

                    <div className="px-6 pb-6 space-y-2">
                        <div className="flex justify-between items-center text-[10px] font-bold text-zinc-500 uppercase">
                            <span>Room Temp Override</span>
                            {state.tempOverride !== undefined && <button onClick={onResetTemp} className="text-orange-500 hover:text-orange-400">Reset</button>}
                        </div>
                        <input type="range" min="60" max="120" step="0.1" value={state.temp} onChange={(e) => onTempChange(parseFloat(e.target.value))} className="w-full h-1.5 bg-zinc-800 rounded-lg appearance-none cursor-pointer" />
                        <div className="flex justify-between text-[8px] font-mono text-zinc-600"><span>60°</span><span>90°</span><span>120°</span></div>
                    </div>

                    <div className={`mt-auto grid ${isReformer ? 'grid-cols-1' : 'grid-cols-3'} border-t border-white/5 bg-zinc-900/30`}>
                        {!isReformer ? (
                            <React.Fragment>
                                <StatusIndicator iconName="fan" label="Fan" active={state.fan} timer={state.fanTimer} />
                                <StatusIndicator iconName="wind" label="Fresh Air" active={state.fa} timer={state.faTimer} />
                                <StatusIndicator iconName="droplets" label="Humid" active={state.hum} />
                            </React.Fragment>
                        ) : (
                            <div className="p-4 text-center text-[10px] font-bold text-zinc-600 uppercase tracking-widest">No Scripted Outputs</div>
                        )}
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [state, setState] = useState({
                currentTime: 0, currentDay: 0, ambientTemp: 75,
                bigRoom: { temp: 70, setpoint: 60, mode: 'Off', fan: false, fa: false, hum: false, fanTimer: 0, faTimer: 0, purgeActive: false, runState: 0 },
                smallRoom: { temp: 70, setpoint: 60, mode: 'Off', fan: false, fa: false, hum: false, fanTimer: 0, faTimer: 0, purgeActive: false, runState: 0 },
                reformerRoom: { temp: 70, setpoint: 60, mode: 'Off', fan: false, fa: false, hum: false, fanTimer: 0, faTimer: 0, purgeActive: false, runState: 0 },
                bigPurgeReq: false, smallPurgeReq: false,
            });
            const [isPlaying, setIsPlaying] = useState(false);
            const [playbackSpeed, setPlaybackSpeed] = useState(1);
            const timerRef = useRef(null);

            useEffect(() => {
                if (isPlaying) {
                    let lastTick = Date.now();
                    let accumulator = 0;
                    timerRef.current = setInterval(() => {
                        const now = Date.now();
                        const delta = (now - lastTick) / 1000;
                        lastTick = now;
                        accumulator += delta * playbackSpeed;
                        if (accumulator >= 1) {
                            const steps = Math.floor(accumulator);
                            accumulator -= steps;
                            setState(prev => {
                                let next = prev;
                                const safeSteps = Math.min(steps, 3600);
                                for (let i = 0; i < safeSteps; i++) {
                                    next = simulateStep(next);
                                    next.currentTime = (next.currentTime + 1) % 86400;
                                    if (next.currentTime === 0) next.currentDay = (next.currentDay + 1) % 7;
                                }
                                return { ...next };
                            });
                        }
                    }, 33);
                } else { clearInterval(timerRef.current); }
                return () => clearInterval(timerRef.current);
            }, [isPlaying, playbackSpeed]);

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            return (
                <div className="min-h-screen p-6">
                    <header className="mb-8 flex items-center justify-between bg-[#1a1b1e] p-6 rounded-2xl border border-white/5">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-orange-600 rounded-lg flex items-center justify-center"><Icon name="activity" className="text-white" /></div>
                            <div>
                                <h1 className="text-lg font-bold">YOGA SOURCE LG</h1>
                                <p className="text-[10px] text-zinc-500 font-mono uppercase tracking-widest">Revision K2 • Standalone Simulator</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="text-right">
                                <div className="text-orange-500 font-mono text-xl font-bold flex items-center gap-2 justify-end"><Icon name="clock" className="w-5 h-5" />{formatTime(state.currentTime)}</div>
                                <div className="text-[10px] text-zinc-500 font-bold uppercase">{DAYS[state.currentDay]} • DAY {state.currentDay + 1}</div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsPlaying(!isPlaying)} className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${isPlaying ? 'bg-orange-600' : 'bg-zinc-800'}`}>
                                    <Icon name={isPlaying ? "pause" : "play"} className="text-white" />
                                </button>
                                <select value={playbackSpeed} onChange={(e) => setPlaybackSpeed(parseInt(e.target.value))} className="bg-zinc-800 rounded-lg px-3 py-2 text-sm font-mono outline-none">
                                    <option value={1}>1x</option><option value={60}>60x</option><option value={600}>600x</option><option value={3600}>3600x</option>
                                </select>
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-12 gap-6">
                        <section className="col-span-12 bg-[#1a1b1e] rounded-2xl border border-white/5 p-4 flex items-center justify-between">
                            <div className="text-[10px] font-bold text-zinc-500 uppercase flex items-center gap-2"><Icon name="info" className="w-4 h-4" />Legend</div>
                            <div className="flex gap-6">
                                <LegendItem color="bg-blue-400" label="73°F" /><LegendItem color="bg-orange-500" label="80°F" /><LegendItem color="bg-orange-600" label="90°F" /><LegendItem color="bg-orange-800" label="95°F" /><LegendItem color="bg-red-600" label="115°F" />
                            </div>
                        </section>

                        <section className="col-span-12 bg-[#1a1b1e] rounded-2xl border border-white/5 p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xs font-bold text-zinc-400 uppercase tracking-widest">Schedules</h2>
                                <div className="flex gap-2">
                                    {DAYS.map((day, idx) => (
                                        <button key={day} onClick={() => setState(p => ({ ...p, currentDay: idx }))} className={`px-2 py-1 rounded text-[10px] font-bold ${state.currentDay === idx ? 'bg-orange-600' : 'text-zinc-500'}`}>{day}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="h-24 bg-zinc-900 rounded-xl overflow-hidden relative">
                                <div className="absolute inset-0 flex flex-col">
                                    <Track label="TULUM" room="big" day={state.currentDay} />
                                    <Track label="BALI" room="small" day={state.currentDay} />
                                    <Track label="REF" room="ref" day={state.currentDay} />
                                </div>
                                <div className="absolute top-0 bottom-0 w-0.5 bg-white z-10" style={{ left: `${(state.currentTime / 86400) * 100}%` }} />
                            </div>
                        </section>

                        <div className="col-span-12 lg:col-span-9 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <RoomCard title="Tulum" state={state.bigRoom} onTempChange={t => setState(p => ({ ...p, bigRoom: { ...p.bigRoom, tempOverride: t } }))} onResetTemp={() => setState(p => ({ ...p, bigRoom: { ...p.bigRoom, tempOverride: undefined } }))} onToggleLock={() => setState(p => ({ ...p, bigRoom: { ...p.bigRoom, tempLocked: !p.bigRoom.tempLocked } }))} />
                            <RoomCard title="Bali" state={state.smallRoom} onTempChange={t => setState(p => ({ ...p, smallRoom: { ...p.smallRoom, tempOverride: t } }))} onResetTemp={() => setState(p => ({ ...p, smallRoom: { ...p.smallRoom, tempOverride: undefined } }))} onToggleLock={() => setState(p => ({ ...p, smallRoom: { ...p.smallRoom, tempLocked: !p.smallRoom.tempLocked } }))} />
                            <RoomCard title="Reformer" state={state.reformerRoom} isReformer onTempChange={t => setState(p => ({ ...p, reformerRoom: { ...p.reformerRoom, tempOverride: t } }))} onResetTemp={() => setState(p => ({ ...p, reformerRoom: { ...p.reformerRoom, tempOverride: undefined } }))} onToggleLock={() => setState(p => ({ ...p, reformerRoom: { ...p.reformerRoom, tempLocked: !p.reformerRoom.tempLocked } }))} />
                        </div>

                        <aside className="col-span-12 lg:col-span-3 space-y-6">
                            <div className="bg-[#1a1b1e] rounded-2xl border border-white/5 p-6">
                                <h2 className="text-xs font-bold text-zinc-400 uppercase mb-6">Environment</h2>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-[10px] font-bold text-zinc-500 uppercase block mb-2">Ambient: {state.ambientTemp}°</label>
                                        <input type="range" min="60" max="110" value={state.ambientTemp} onChange={e => setState(p => ({ ...p, ambientTemp: parseInt(e.target.value) }))} className="w-full" />
                                    </div>
                                    <button onClick={() => setState(p => ({ ...p, bigPurgeReq: !p.bigPurgeReq }))} className={`w-full py-3 rounded-xl border text-[10px] font-bold uppercase ${state.bigPurgeReq ? 'border-emerald-500 text-emerald-500' : 'border-white/5 text-zinc-500'}`}>Tulum Purge</button>
                                    <button onClick={() => setState(p => ({ ...p, smallPurgeReq: !p.smallPurgeReq }))} className={`w-full py-3 rounded-xl border text-[10px] font-bold uppercase ${state.smallPurgeReq ? 'border-emerald-500 text-emerald-500' : 'border-white/5 text-zinc-500'}`}>Bali Purge</button>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        }

        function Track({ label, room, day }) {
            const slots = [];
            for (let i = 0; i < 96; i++) slots.push(getScheduleChar(room, day, i * 900));
            return (
                <div className="flex-1 flex items-center border-b border-white/5 last:border-0">
                    <div className="w-12 text-[8px] font-bold text-zinc-600 pl-2">{label}</div>
                    <div className="flex-1 h-full flex">
                        {slots.map((char, i) => <div key={i} className={`flex-1 h-full border-r border-black/10 ${COLOR_MAP[char] || ''}`} />)}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
